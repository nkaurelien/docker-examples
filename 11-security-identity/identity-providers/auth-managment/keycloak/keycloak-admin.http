### Keycloak Admin API
### REST Client file for testing Keycloak API endpoints
###
### Prerequisites:
###   - Keycloak running on localhost:8080
###   - Admin credentials configured in .env
###
### Usage in VS Code: Install "REST Client" extension
### Usage in IntelliJ: Built-in HTTP Client support

@baseUrl = http://localhost:8080
@realm = my-realm
@adminUsername = admin
@adminPassword = changeme


### ============================================
### AUTHENTICATION
### ============================================

### Get Admin Access Token
# @name getAdminToken
POST {{baseUrl}}/realms/master/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=admin-cli&username={{adminUsername}}&password={{adminPassword}}

###
@accessToken = {{getAdminToken.response.body.access_token}}


### ============================================
### REALM INFO & SETTINGS
### ============================================

### Get Realm Info
GET {{baseUrl}}/admin/realms/{{realm}}
Authorization: Bearer {{accessToken}}

### Get Realm Keys
GET {{baseUrl}}/admin/realms/{{realm}}/keys
Authorization: Bearer {{accessToken}}

### Check Health
GET {{baseUrl}}/health/ready

### Update Realm Settings
### IMPORTANT: registrationEmailAsUsername must be false if you use custom usernames
### IMPORTANT: editUsernameAllowed must be true to change usernames via Admin API
PUT {{baseUrl}}/admin/realms/{{realm}}
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "registrationEmailAsUsername": false,
  "editUsernameAllowed": true,
  "loginWithEmailAllowed": true
}


### ============================================
### USERS MANAGEMENT
### ============================================

### List All Users (max 20)
GET {{baseUrl}}/admin/realms/{{realm}}/users?max=20
Authorization: Bearer {{accessToken}}

### Count Users
GET {{baseUrl}}/admin/realms/{{realm}}/users/count
Authorization: Bearer {{accessToken}}

### Search User by Email
# @name searchUser
GET {{baseUrl}}/admin/realms/{{realm}}/users?email=user@example.com&exact=true
Authorization: Bearer {{accessToken}}

###
@userId = {{searchUser.response.body.[0].id}}

### Get User by ID
GET {{baseUrl}}/admin/realms/{{realm}}/users/{{userId}}
Authorization: Bearer {{accessToken}}

### Get User Role Mappings
GET {{baseUrl}}/admin/realms/{{realm}}/users/{{userId}}/role-mappings/realm
Authorization: Bearer {{accessToken}}

### Search Users by Attribute
GET {{baseUrl}}/admin/realms/{{realm}}/users?q=user_type:admin&max=20
Authorization: Bearer {{accessToken}}

### Create New User
POST {{baseUrl}}/admin/realms/{{realm}}/users
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "username": "newuser",
  "email": "newuser@example.com",
  "emailVerified": true,
  "enabled": true,
  "firstName": "New",
  "lastName": "User",
  "attributes": {
    "external_user_id": ["ext-12345"],
    "user_type": ["user"],
    "phoneNumber": ["+33612345678"]
  },
  "credentials": [
    {
      "type": "password",
      "value": "TempPassword2024!",
      "temporary": true
    }
  ]
}

### Update User — Set username + attributes
### Replace userId with actual UUID
PUT {{baseUrl}}/admin/realms/{{realm}}/users/{{userId}}
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "username": "custom-username",
  "attributes": {
    "external_user_id": ["ext-12345"],
    "user_type": ["user"],
    "phoneNumber": ["+33612345678"]
  }
}

### Delete User by ID (Careful!)
# DELETE {{baseUrl}}/admin/realms/{{realm}}/users/{{userId}}
# Authorization: Bearer {{accessToken}}


### ============================================
### USER PROFILE (Keycloak 24+)
### ============================================

### Get User Profile Configuration
GET {{baseUrl}}/admin/realms/{{realm}}/users/profile
Authorization: Bearer {{accessToken}}

### Configure User Profile with Custom Attributes
### IMPORTANT: All custom attributes must be declared here
### otherwise Keycloak 24 silently drops them on PUT
PUT {{baseUrl}}/admin/realms/{{realm}}/users/profile
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "attributes": [
    {
      "name": "username",
      "displayName": "${username}",
      "validations": {
        "length": { "min": 3, "max": 255 },
        "username-prohibited-characters": {},
        "up-username-not-idn-homograph": {}
      },
      "permissions": {
        "view": ["admin", "user"],
        "edit": ["admin", "user"]
      },
      "multivalued": false
    },
    {
      "name": "email",
      "displayName": "${email}",
      "validations": {
        "email": {},
        "length": { "max": 255 }
      },
      "required": {
        "roles": ["user"]
      },
      "permissions": {
        "view": ["admin", "user"],
        "edit": ["admin", "user"]
      },
      "multivalued": false
    },
    {
      "name": "firstName",
      "displayName": "${firstName}",
      "validations": {
        "length": { "max": 255 },
        "person-name-prohibited-characters": {}
      },
      "required": {
        "roles": ["user"]
      },
      "permissions": {
        "view": ["admin", "user"],
        "edit": ["admin", "user"]
      },
      "multivalued": false
    },
    {
      "name": "lastName",
      "displayName": "${lastName}",
      "validations": {
        "length": { "max": 255 },
        "person-name-prohibited-characters": {}
      },
      "required": {
        "roles": ["user"]
      },
      "permissions": {
        "view": ["admin", "user"],
        "edit": ["admin", "user"]
      },
      "multivalued": false
    },
    {
      "name": "external_user_id",
      "displayName": "External User ID",
      "permissions": {
        "view": ["admin"],
        "edit": ["admin"]
      },
      "multivalued": false
    },
    {
      "name": "user_type",
      "displayName": "User Type",
      "permissions": {
        "view": ["admin"],
        "edit": ["admin"]
      },
      "multivalued": false
    },
    {
      "name": "phoneNumber",
      "displayName": "Phone Number",
      "permissions": {
        "view": ["admin", "user"],
        "edit": ["admin", "user"]
      },
      "multivalued": false
    }
  ],
  "groups": [
    {
      "name": "user-metadata",
      "displayHeader": "User metadata",
      "displayDescription": "Attributes, which refer to user metadata"
    }
  ]
}


### ============================================
### CLIENT SCOPES & TOKEN MAPPERS
### ============================================

### List Client Scopes
GET {{baseUrl}}/admin/realms/{{realm}}/client-scopes
Authorization: Bearer {{accessToken}}


### ============================================
### ROLES MANAGEMENT
### ============================================

### List Realm Roles
GET {{baseUrl}}/admin/realms/{{realm}}/roles
Authorization: Bearer {{accessToken}}

### Get a Specific Role
GET {{baseUrl}}/admin/realms/{{realm}}/roles/app-user
Authorization: Bearer {{accessToken}}

### Get Users with a Role
GET {{baseUrl}}/admin/realms/{{realm}}/roles/app-user/users
Authorization: Bearer {{accessToken}}

### Assign Role to User
### First get role ID, then POST
# @name getAppUserRole
# GET {{baseUrl}}/admin/realms/{{realm}}/roles/app-user
# Authorization: Bearer {{accessToken}}
#
# POST {{baseUrl}}/admin/realms/{{realm}}/users/{{userId}}/role-mappings/realm
# Authorization: Bearer {{accessToken}}
# Content-Type: application/json
#
# [{"id": "ROLE_UUID", "name": "app-user"}]


### ============================================
### CLIENTS
### ============================================

### List All Clients
GET {{baseUrl}}/admin/realms/{{realm}}/clients
Authorization: Bearer {{accessToken}}

### Get Frontend Client
# @name getFrontendClient
GET {{baseUrl}}/admin/realms/{{realm}}/clients?clientId=my-frontend
Authorization: Bearer {{accessToken}}

###
@frontendClientUuid = {{getFrontendClient.response.body.[0].id}}

### Get Frontend Client Secret
GET {{baseUrl}}/admin/realms/{{realm}}/clients/{{frontendClientUuid}}/client-secret
Authorization: Bearer {{accessToken}}

### Regenerate Frontend Client Secret
POST {{baseUrl}}/admin/realms/{{realm}}/clients/{{frontendClientUuid}}/client-secret
Authorization: Bearer {{accessToken}}

### Get Backend Client
GET {{baseUrl}}/admin/realms/{{realm}}/clients?clientId=my-backend
Authorization: Bearer {{accessToken}}

### Get Admin Service Client
# @name getAdminClient
GET {{baseUrl}}/admin/realms/{{realm}}/clients?clientId=my-admin-service
Authorization: Bearer {{accessToken}}

###
@adminClientUuid = {{getAdminClient.response.body.[0].id}}

### Get Admin Service Client Secret
GET {{baseUrl}}/admin/realms/{{realm}}/clients/{{adminClientUuid}}/client-secret
Authorization: Bearer {{accessToken}}


### ============================================
### OIDC WELL-KNOWN & TOKENS
### ============================================

### Get OpenID Connect Discovery
GET {{baseUrl}}/realms/{{realm}}/.well-known/openid-configuration

### Get JWKS (public keys for RS256 token verification)
GET {{baseUrl}}/realms/{{realm}}/protocol/openid-connect/certs

### Get User Token via ROPC (password grant)
### Use my-backend client for backend auth testing
POST {{baseUrl}}/realms/{{realm}}/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id=my-backend&client_secret=BACKEND_CLIENT_SECRET&username=USER_EMAIL&password=USER_PASSWORD

### Introspect Token
# POST {{baseUrl}}/realms/{{realm}}/protocol/openid-connect/token/introspect
# Content-Type: application/x-www-form-urlencoded
#
# token=PASTE_TOKEN_HERE&client_id=my-backend&client_secret=BACKEND_CLIENT_SECRET

### Token Exchange (Service Account — client_credentials)
# @name getServiceToken
POST {{baseUrl}}/realms/{{realm}}/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials&client_id=my-admin-service&client_secret=CHANGE_ME

###
@serviceToken = {{getServiceToken.response.body.access_token}}

### Use Service Account Token to List Users
GET {{baseUrl}}/admin/realms/{{realm}}/users?max=5
Authorization: Bearer {{serviceToken}}


### ============================================
### THEME MANAGEMENT
### ============================================

### Update Realm Themes
PUT {{baseUrl}}/admin/realms/{{realm}}
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "loginTheme": "my-app",
  "accountTheme": "my-app",
  "emailTheme": "my-app"
}

### List Available Themes (Server Info)
GET {{baseUrl}}/admin/serverinfo
Authorization: Bearer {{accessToken}}


### ============================================
### EVENTS & AUDIT
### ============================================

### Get Recent Login Events
GET {{baseUrl}}/admin/realms/{{realm}}/events?type=LOGIN&max=20
Authorization: Bearer {{accessToken}}

### Get Recent Admin Events
GET {{baseUrl}}/admin/realms/{{realm}}/admin-events?max=20
Authorization: Bearer {{accessToken}}

### Get Login Error Events
GET {{baseUrl}}/admin/realms/{{realm}}/events?type=LOGIN_ERROR&max=20
Authorization: Bearer {{accessToken}}