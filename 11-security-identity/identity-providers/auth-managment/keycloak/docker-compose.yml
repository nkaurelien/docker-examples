# Keycloak Identity Provider with PostgreSQL
# Usage:
#   cp .env.example .env
#   # Edit .env with your values
#   docker compose up -d

services:
  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    container_name: keycloak
    command: start --import-realm
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}

      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: ${KC_DB_USERNAME:-keycloak}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD}

      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-localhost}
      KC_HOSTNAME_STRICT: "false"

      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"
      KC_HTTP_PORT: 8080

      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_FEATURES: token-exchange,admin-fine-grained-authz

      KC_SPI_THEME_CACHE_THEMES: "false"
      KC_SPI_THEME_CACHE_TEMPLATES: "false"

      KC_LOG_CONSOLE_OUTPUT: json
      KC_LOG_LEVEL: ${KC_LOG_LEVEL:-info}

      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_FROM: ${SMTP_FROM:-noreply@example.com}
      SMTP_FROM_DISPLAY_NAME: ${SMTP_FROM_DISPLAY_NAME:-My App}
      SMTP_REPLY_TO: ${SMTP_REPLY_TO:-support@example.com}
      SMTP_REPLY_TO_DISPLAY_NAME: ${SMTP_REPLY_TO_DISPLAY_NAME:-Support}
      SMTP_SSL: ${SMTP_SSL:-false}
      SMTP_STARTTLS: ${SMTP_STARTTLS:-true}
      SMTP_AUTH: ${SMTP_AUTH:-true}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}

    volumes:
      - ./realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - ./providers:/opt/keycloak/providers:ro
      - ./themes/my-app:/opt/keycloak/themes/my-app:ro
      - keycloak-data:/opt/keycloak/data
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\\r\\nhost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - keycloak-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 512M

  keycloak-init:
    image: curlimages/curl:8.5.0
    container_name: keycloak-init
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: my-realm
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
    volumes:
      - ./scripts:/scripts:ro
    entrypoint: ["/bin/sh", "/scripts/init-user-profile.sh"]
    networks:
      - keycloak-network
    restart: "no"

  keycloak-db:
    image: postgres:16-alpine
    container_name: keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: ${KC_DB_USERNAME:-keycloak}
      POSTGRES_PASSWORD: ${KC_DB_PASSWORD}
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - keycloak-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

volumes:
  keycloak-data:
    driver: local
  keycloak-db-data:
    driver: local

networks:
  keycloak-network:
    driver: bridge
