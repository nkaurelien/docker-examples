# Wazuh - Open Source SIEM/XDR Platform
# https://documentation.wazuh.com/current/deployment-options/docker/index.html
# Security monitoring, intrusion detection, compliance

services:
  # Wazuh Indexer - Data storage (OpenSearch fork)
  wazuh-indexer:
    image: wazuh/wazuh-indexer:${WAZUH_VERSION:-4.9.0}
    container_name: wazuh-indexer
    restart: unless-stopped
    hostname: wazuh.indexer
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - "bootstrap.memory_lock=true"
      - "discovery.type=single-node"
      - "plugins.security.ssl.http.enabled=true"
      - "plugins.security.ssl.http.pemcert_filepath=/usr/share/wazuh-indexer/certs/wazuh.indexer.pem"
      - "plugins.security.ssl.http.pemkey_filepath=/usr/share/wazuh-indexer/certs/wazuh.indexer-key.pem"
      - "plugins.security.ssl.http.pemtrustedcas_filepath=/usr/share/wazuh-indexer/certs/root-ca.pem"
      - "plugins.security.ssl.transport.pemcert_filepath=/usr/share/wazuh-indexer/certs/wazuh.indexer.pem"
      - "plugins.security.ssl.transport.pemkey_filepath=/usr/share/wazuh-indexer/certs/wazuh.indexer-key.pem"
      - "plugins.security.ssl.transport.pemtrustedcas_filepath=/usr/share/wazuh-indexer/certs/root-ca.pem"
      - "plugins.security.authcz.admin_dn=CN=admin,OU=Wazuh,O=Wazuh,L=California,C=US"
      - "plugins.security.check_snapshot_restore_write_privileges=true"
      - "plugins.security.enable_snapshot_restore_privilege=true"
      - "plugins.security.nodes_dn=CN=wazuh.indexer,OU=Wazuh,O=Wazuh,L=California,C=US"
      - "plugins.security.restapi.roles_enabled=all_access,security_rest_api_access"
      - "cluster.routing.allocation.disk.threshold_enabled=false"
      - "compatibility.override_main_response_version=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer
      - ./config/wazuh_indexer_ssl_certs/:/usr/share/wazuh-indexer/certs/
    networks:
      - wazuh-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "curl -sk https://localhost:9200 -u admin:${INDEXER_PASSWORD:-SecretPassword} | grep -q 'wazuh'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Wazuh Manager - Analysis engine
  wazuh-manager:
    image: wazuh/wazuh-manager:${WAZUH_VERSION:-4.9.0}
    container_name: wazuh-manager
    restart: unless-stopped
    hostname: wazuh.manager
    ports:
      - "1514:1514"      # Agent connection
      - "1515:1515"      # Agent enrollment
      - "514:514/udp"    # Syslog
      - "55000:55000"    # Wazuh API
    environment:
      - INDEXER_URL=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${INDEXER_PASSWORD:-SecretPassword}
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat-key.pem
      - API_USERNAME=${API_USERNAME:-wazuh-wui}
      - API_PASSWORD=${API_PASSWORD:-MyS3cr37P450r.*-}
    volumes:
      - wazuh-manager-api:/var/ossec/api/configuration
      - wazuh-manager-etc:/var/ossec/etc
      - wazuh-manager-logs:/var/ossec/logs
      - wazuh-manager-queue:/var/ossec/queue
      - wazuh-manager-var:/var/ossec/var/multigroups
      - wazuh-manager-integrations:/var/ossec/integrations
      - wazuh-manager-active-response:/var/ossec/active-response/bin
      - wazuh-manager-agentless:/var/ossec/agentless
      - wazuh-manager-wodles:/var/ossec/wodles
      - ./config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.manager.pem:/etc/ssl/filebeat.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.manager-key.pem:/etc/ssl/filebeat-key.pem
      - ./config/wazuh_cluster/wazuh_manager.conf:/wazuh-config-mount/etc/ossec.conf
    networks:
      - wazuh-network
    depends_on:
      wazuh-indexer:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # Wazuh Dashboard - Web UI (OpenSearch Dashboards fork)
  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:${WAZUH_VERSION:-4.9.0}
    container_name: wazuh-dashboard
    restart: unless-stopped
    hostname: wazuh.dashboard
    ports:
      - "5601:5601"
    environment:
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${INDEXER_PASSWORD:-SecretPassword}
      - WAZUH_API_URL=https://wazuh.manager
      - DASHBOARD_USERNAME=kibanaserver
      - DASHBOARD_PASSWORD=${DASHBOARD_PASSWORD:-kibanaserver}
      - API_USERNAME=${API_USERNAME:-wazuh-wui}
      - API_PASSWORD=${API_PASSWORD:-MyS3cr37P450r.*-}
    volumes:
      - ./config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
      - ./config/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem
      - ./config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-dashboard/certs/root-ca.pem
      - ./config/wazuh_dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
      - ./config/wazuh_dashboard/wazuh.yml:/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
      - wazuh-dashboard-custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom
    networks:
      - wazuh-network
      - traefik-public
    depends_on:
      wazuh-indexer:
        condition: service_healthy
      wazuh-manager:
        condition: service_started
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wazuh.rule=Host(`wazuh.apps.local`)"
      - "traefik.http.routers.wazuh.entrypoints=websecure"
      - "traefik.http.routers.wazuh.tls=true"
      - "traefik.http.services.wazuh.loadbalancer.server.port=5601"
      - "traefik.http.services.wazuh.loadbalancer.server.scheme=https"
    healthcheck:
      test: ["CMD-SHELL", "curl -sk https://localhost:5601/api/status | grep -q 'available'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

volumes:
  wazuh-indexer-data:
    driver: local
  wazuh-manager-api:
    driver: local
  wazuh-manager-etc:
    driver: local
  wazuh-manager-logs:
    driver: local
  wazuh-manager-queue:
    driver: local
  wazuh-manager-var:
    driver: local
  wazuh-manager-integrations:
    driver: local
  wazuh-manager-active-response:
    driver: local
  wazuh-manager-agentless:
    driver: local
  wazuh-manager-wodles:
    driver: local
  wazuh-dashboard-custom:
    driver: local

networks:
  wazuh-network:
    driver: bridge
  traefik-public:
    external: true
