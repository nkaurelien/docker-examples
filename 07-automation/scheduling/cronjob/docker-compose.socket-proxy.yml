services:

  #######################################
  # Docker Socket Proxy: Secure Docker API access
  #######################################
  socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: ofelia-socket-proxy
    restart: unless-stopped
    networks:
      - socket-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Ofelia needs read access to containers and exec
      # Deny write operations
      - POST=0
      # API sections - minimal for Ofelia
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - CONTAINERS=1          # Required: read container labels
      - DISTRIBUTION=0
      - EXEC=1                # Required: execute commands in containers
      - GRPC=0
      - IMAGES=0
      - INFO=0
      - NETWORKS=0
      - NODES=0
      - PLUGINS=0
      - SERVICES=0
      - SESSION=0
      - SWARM=0
      - SYSTEM=0
      - TASKS=0
      - VOLUMES=0
      # Container-specific controls
      - ALLOW_START=0
      - ALLOW_STOP=0
      - ALLOW_RESTARTS=0
      # Secrets (disabled)
      - SECRETS=0
      # Events (needed for container discovery)
      - EVENTS=1

  #######################################
  # Ofelia: Job scheduler for Docker
  #######################################
  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ofelia
    restart: unless-stopped
    command: daemon --docker -d tcp://socket-proxy:2375
    depends_on:
      - socket-proxy
      - nginx
      - bullmq
      - agenda
    networks:
      - socket-proxy
      - default
    labels:
      ofelia.job-local.my-test-job.schedule: "@every 5s"
      ofelia.job-local.my-test-job.command: "date"

  nginx:
    image: nginx
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.datecron.schedule: "@every 5s"
      ofelia.job-exec.datecron.command: "uname -a"

  agenda:
    build:
      context: ./
      dockerfile: Dockerfile
    command: "node build/agenda.js"
    depends_on:
      - mongodb
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.agenda-uname-cron.schedule: "@every 5s"
      ofelia.job-exec.agenda-uname-cron.command: "uname -a"

  bullmq:
    build:
      context: ./
      dockerfile: Dockerfile
    command: "node build/bullmq.js"
    depends_on:
      - redis
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.bullmq-uname-cron.schedule: "@every 5s"
      ofelia.job-exec.bullmq-uname-cron.command: "uname -a"

  pm2-node-cron:
    build:
      context: ./
      dockerfile: Dockerfile
    command: "npx pm2 start pm2.ecosystem.config.js"
    depends_on:
      - mongodb
      - redis

  pm2-cron:
    build:
      context: ./
      dockerfile: Dockerfile
    command: "npx pm2 start build/pm2-buildin-cronjob.js --no-autorestart --instances 1 --cronjob \"*/5 * * * * *\""
    depends_on:
      - mongodb
      - redis

  redis:
    image: "redis:alpine"
    ports:
      - "6379:6379"

  mongodb:
    image: "mongo:4.4"
    ports:
      - "27017:27017"

networks:
  socket-proxy:
    name: ofelia-socket-proxy
    driver: bridge
    internal: true
