services:

  couchdb-0:
    hostname: couchdb-0.${COUCHDB_NODE_NAME:-couchdb-cluster}
    restart: unless-stopped
    environment:
      COUCHDB_USER: ${COUCHDB_USER}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
      COUCHDB_SECRET: ${COUCHDB_SECRET}
      NODENAME: couchdb-0.${COUCHDB_NODE_NAME:-couchdb-cluster}
      ERL_FLAGS: "-setcookie ${COUCHDB_COOKIE}"
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
    image: couchdb:3.4.2
    # Ofelia backup job configuration via Docker labels
    # These labels are read by Ofelia when running in "daemon --docker" mode
    # To modify: edit labels here, then run: docker-compose up -d couchdb-0 && docker-compose restart ofelia
    labels:
      ofelia.enabled: "true"
      ofelia.job-exec.couchdb-backup-daily.schedule: "0 2 * * *"  # Daily at 2 AM
      ofelia.job-exec.couchdb-backup-daily.command: "/opt/scripts/backup-job.sh"
    networks:
      asone4health_network:
        ipv4_address: ${NODE0_IP}
    ports:
      - "${PORT_BASE}0:5984"
    volumes:
      - "data-couch-0:/opt/couchdb/data"
      - "./config/couchdb0/local.ini:/opt/couchdb/etc/local.ini"
      - "./manage:/opt/manage:ro"
      - "./scripts:/opt/scripts:ro"
      - "./backups:/opt/backups"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  couchdb-1:
    hostname: couchdb-1.${COUCHDB_NODE_NAME:-couchdb-cluster}
    restart: unless-stopped
    environment:
      COUCHDB_USER: ${COUCHDB_USER}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
      COUCHDB_SECRET: ${COUCHDB_SECRET}
      NODENAME: couchdb-1.${COUCHDB_NODE_NAME:-couchdb-cluster}
      ERL_FLAGS: "-setcookie ${COUCHDB_COOKIE}"
    image: couchdb:3.4.2
    networks:
      asone4health_network:
        ipv4_address: ${NODE1_IP}
    ports:
      - "${PORT_BASE}1:5984"
    volumes:
      - "data-couch-1:/opt/couchdb/data"
      - "./config/couchdb1/local.ini:/opt/couchdb/etc/local.ini"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  couchdb-2:
    hostname: couchdb-2.${COUCHDB_NODE_NAME:-couchdb-cluster}
    restart: unless-stopped
    environment:
      COUCHDB_USER: ${COUCHDB_USER}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
      COUCHDB_SECRET: ${COUCHDB_SECRET}
      NODENAME: couchdb-2.${COUCHDB_NODE_NAME:-couchdb-cluster}
      ERL_FLAGS: "-setcookie ${COUCHDB_COOKIE}"
    image: couchdb:3.4.2
    networks:
      asone4health_network:
        ipv4_address: ${NODE2_IP}
    ports:
      - "${PORT_BASE}2:5984"
    volumes:
      - "data-couch-2:/opt/couchdb/data"
      - "./config/couchdb2/local.ini:/opt/couchdb/etc/local.ini"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Service pour initialiser le cluster automatiquement
  cluster-init:
    image: curlimages/curl:latest
    container_name: ${COMPOSE_PROJECT_NAME}_cluster-init_1
    depends_on:
      couchdb-0:
        condition: service_healthy
      couchdb-1:
        condition: service_healthy
      couchdb-2:
        condition: service_healthy
    environment:
      - COUCHDB_USER=${COUCHDB_USER}
      - COUCHDB_PASSWORD=${COUCHDB_PASSWORD}
      - COUCHDB_NODE_NAME=${COUCHDB_NODE_NAME}
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
    networks:
      asone4health_network:
        ipv4_address: ${CLUSTER_INIT_IP}
    volumes:
      - ./init-cluster-docker.sh:/init-cluster.sh:ro
    command: ["/bin/sh", "/init-cluster.sh"]
    restart: "no"

  # CouchDB Management UI
  couchdb-manager:
    build:
      context: .
      dockerfile_inline: |
        FROM python:3.11-slim
        WORKDIR /app
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        COPY couchdb_manager.py .
        COPY manage/ ./manage/
        RUN mkdir -p backups
        EXPOSE 8501
        HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
          CMD curl -f http://localhost:8501/_stcore/health || exit 1
        CMD ["streamlit", "run", "couchdb_manager.py", \
             "--server.port=8501", \
             "--server.address=0.0.0.0", \
             "--server.headless=true", \
             "--browser.gatherUsageStats=false"]
    container_name: ${COMPOSE_PROJECT_NAME}_couchdb-manager_1
    depends_on:
      couchdb-0:
        condition: service_healthy
      couchdb-1:
        condition: service_healthy
      couchdb-2:
        condition: service_healthy
    environment:
      - SOURCE_COUCHDB_URL=${SOURCE_COUCHDB_URL}
      - TARGET_COUCHDB_URL=${TARGET_COUCHDB_URL}
    networks:
      asone4health_network:
        ipv4_address: ${MANAGER_IP:-172.19.0.24}
    ports:
      - "8501:8501"
    volumes:
      - ./backups:/app/backups
      - ./manage:/app/manage:ro
    restart: unless-stopped

  # Ofelia Job Scheduler
  # Runs in "daemon --docker" mode to read job configurations from container labels
  # Alternative: Use "daemon --config" mode to read from config/ofelia.ini file
  # See README.md for detailed configuration instructions
  ofelia:
    image: mcuadros/ofelia:latest
    container_name: ${COMPOSE_PROJECT_NAME}_ofelia_1
    command: daemon --docker  # Docker labels mode (reads labels from containers)
    depends_on:
      couchdb-0:
        condition: service_healthy
      couchdb-1:
        condition: service_healthy
      couchdb-2:
        condition: service_healthy
    networks:
      asone4health_network:
        ipv4_address: ${BACKUP_SERVICE_IP:-172.19.0.25}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    profiles: ["backup"]


networks:
  asone4health_network:
    external: true


volumes:
  data-couch-0:
  cfg-couch-0:
  data-couch-1:
  cfg-couch-1:
  data-couch-2:
  cfg-couch-2:
